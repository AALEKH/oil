#!/usr/bin/env python2
"""
build/NINJA_subgraph.py

Directory structure:

_bin/
  pystub/
    asdl_tool
    lexer_gen

build/
  NINJA-steps.sh
"""

from __future__ import print_function

import os
import subprocess
import sys

def log(msg, *args):
  if args:
    msg = msg % args
  print(msg, file=sys.stderr)


def NinjaGraph(n):

  n.comment('Build tools')
  n.comment('Generated by %s.' % __file__)
  n.newline()

  # Preprocess one translation unit
  n.rule('make-pystub',
         # $in starts with main program?
         command='build/NINJA-steps.sh make-pystub $out $in',
         description='make-pystub $out $in')
  n.newline()

  # build/app-deps.sh asdl-tool gives us the dependencies
  #
  # This filters with build/app-deps/filter-py-tool.txt
  #
  # But how do we put asdl/tool.py at the front?  Do it manually?

  p = subprocess.Popen(['build/app-deps.sh', 'py-tool', 'asdl.asdl_main'], stdout=subprocess.PIPE)
  for line in p.stdout:
    dep = line.strip()
    print('# %s' % dep)
  status = p.wait()
  log('status %d', status)

  deps = []
  n.build('_bin/pystubs/asdl_tool', 'make-pystub', deps)

  n.build('_bin/pystubs/optview_gen', 'make-pystub', deps)
